# -----------------------------
# Stage 1: Builder — build Blender, addons, MCP server
# -----------------------------
FROM ubuntu:22.04 AS builder

ENV DEBIAN_FRONTEND=noninteractive
WORKDIR /build

# System dependencies
RUN apt-get update && apt-get install -y \
    wget unzip bzip2 git libfreetype6 libgl1-mesa-glx libglu1-mesa \
    libxi6 libxrender1 libgomp1 libgeos-dev xvfb libxkbcommon0 \
    python3.11 python3.11-venv python3-pip \
    && rm -rf /var/lib/apt/lists/*

# Install Blender 4.4
RUN wget -q https://download.blender.org/release/Blender4.4/blender-4.4.0-linux-x64.tar.xz \
    && tar -xf blender-4.4.0-linux-x64.tar.xz \
    && mv blender-4.4.0-linux-x64 /opt/blender \
    && ln -s /opt/blender/blender /usr/local/bin/blender

# Install BlenderBIM / Bonsai add-on
RUN wget -q https://github.com/IfcOpenShell/IfcOpenShell/releases/download/blenderbim-240602/blenderbim-240602-py311-linux.zip \
    -O /root/blenderbim.zip \
    && mkdir -p /opt/blender_addons/scripts/addons \
    && unzip -q /root/blenderbim.zip -d /opt/blender_addons/scripts/addons/ \
    && rm /root/blenderbim.zip

# Fix shapely & lxml inside Blender's Python
RUN /opt/blender/4.4/python/bin/python3.11 -m ensurepip \
    && /opt/blender/4.4/python/bin/python3.11 -m pip install --upgrade pip \
    && /opt/blender/4.4/python/bin/python3.11 -m pip install shapely==2.0.2 lxml==5.1.0

# Copy local ifc-bonsai-mcp source into builder (included in repo as ifc-bonsai-mcp-main)
COPY ifc-bonsai-mcp-main /opt/ifc-bonsai-mcp
WORKDIR /opt/ifc-bonsai-mcp
# Build with python3.11 for best compatibility
RUN python3.11 -m pip install --upgrade pip setuptools wheel build || true
RUN python3.11 -m pip install . || true

# Install libraries needed by MCP + Blender scripts
RUN /opt/blender/4.4/python/bin/python3.11 -m pip install websockets trimesh numpy

# Prepare runtime folder for final image - strip unnecessary files to reduce size
RUN mkdir -p /opt/app_runtime
RUN cp -r /opt/blender /opt/app_runtime/blender
# Remove Blender debug/test files to reduce size
RUN find /opt/app_runtime/blender -type f \( -name "*.pyc" -o -name "__pycache__" -o -name "*.so.debug" \) -delete
RUN rm -rf /opt/app_runtime/blender/4.4/python/lib/python3.11/site-packages/pip* /opt/app_runtime/blender/4.4/python/lib/python3.11/site-packages/setuptools*
RUN cp -r /opt/blender_addons /opt/app_runtime/blender_addons

# -----------------------------
# Stage 2: Runtime — minimal / final image
# -----------------------------
FROM ubuntu:22.04 AS runtime

ENV DEBIAN_FRONTEND=noninteractive
WORKDIR /app

# Install only runtime dependencies (minimal set)
RUN apt-get update && apt-get install -y \
    libfreetype6 libgl1-mesa-glx libglu1-mesa libxi6 libxrender1 \
    libgomp1 libgeos-dev xvfb libxkbcommon0 python3.11 python3-pip \
    && rm -rf /var/lib/apt/lists/* /var/cache/apt/*

# Copy built Blender + MCP + addons from builder
COPY --from=builder /opt/app_runtime /opt/app_runtime
COPY --from=builder /opt/ifc-bonsai-mcp /opt/app_runtime/ifc-bonsai-mcp

# Setup Blender config directory with addons
RUN mkdir -p /root/.config/blender/4.4/scripts && \
    ln -s /opt/app_runtime/blender_addons/scripts/addons /root/.config/blender/4.4/scripts/addons

# Add Blender to PATH
ENV PATH="/opt/app_runtime/blender:${PATH}"
RUN ln -s /opt/app_runtime/blender/blender /usr/local/bin/blender

# Copy and install your application
COPY requirements.txt ./

# Use system pip3 for installs
RUN pip3 install --upgrade pip setuptools wheel

# Install the MCP package from the copied source directory
RUN pip3 install --no-cache-dir /opt/app_runtime/ifc-bonsai-mcp || true

# Install application requirements
RUN pip3 install --no-cache-dir -r requirements.txt

# Clean up pip cache to reduce image size
RUN rm -rf /root/.cache/pip

# Make python3 point to python3.11 so scripts using `python3` use the same interpreter
RUN if [ -x /usr/bin/python3.11 ]; then update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1 || ln -sf /usr/bin/python3.11 /usr/bin/python3; fi

COPY main.py blender_generator.py mcp_client.py start.sh ./
RUN chmod +x start.sh

EXPOSE ${PORT}
CMD ["./start.sh"]



